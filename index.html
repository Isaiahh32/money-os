<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Money OS</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Money OS">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0c">

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#111116;
      --card:#15151c;
      --stroke:#262633;
      --text:#f2f2f2;
      --muted:#b6b6c2;

      --accent:#7c5cff;
      --accent2:#2dd4bf;

      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(700px 400px at 90% 0%, rgba(45,212,191,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(to bottom, rgba(11,11,12,.92), rgba(11,11,12,.70));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(38,38,51,.6);
      padding: 14px 16px 10px;
    }
    header .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      max-width:980px; margin:0 auto;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; }

    .wrap{ max-width:980px; margin:0 auto; padding: 14px 16px 88px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(21,21,28,.92), rgba(17,17,22,.92));
      border: 1px solid rgba(38,38,51,.9);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 13px;
      color: rgba(242,242,242,.88);
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .big{ font-size:22px; font-weight:900; letter-spacing:.2px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:800;
      border:1px solid rgba(38,38,51,.9);
      background: rgba(15,15,18,.9);
      color: var(--muted);
    }
    .pill.ok{ color:#06251f; background: rgba(45,212,191,.95); border-color: rgba(45,212,191,.5); }
    .pill.warn{ color:#2b1d00; background: rgba(251,191,36,.95); border-color: rgba(251,191,36,.5); }
    .pill.bad{ color:#2b0b12; background: rgba(251,113,133,.95); border-color: rgba(251,113,133,.5); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 140px; }

    label{ display:block; margin-top:10px; margin-bottom:6px; font-size:12px; color: var(--muted); }

    input, select, button{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(38,38,51,.95);
      background: rgba(15,15,18,.9);
      color: var(--text);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }

    input:focus, select:focus{
      border-color: rgba(124,92,255,.9);
      box-shadow: 0 0 0 3px rgba(124,92,255,.18);
    }

    button{
      cursor:pointer;
      border:none;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), #4c35ff);
      box-shadow: 0 10px 22px rgba(124,92,255,.18);
    }
    button.secondary{
      background: rgba(42,42,55,.75);
      border:1px solid rgba(70,70,90,.55);
      box-shadow:none;
    }
    button.ghost{
      background: transparent;
      border:1px solid rgba(70,70,90,.55);
      box-shadow:none;
    }
    button.danger{
      background: linear-gradient(135deg, #fb7185, #ef4444);
      box-shadow: 0 10px 22px rgba(239,68,68,.16);
    }

    .line{ height:1px; background: rgba(38,38,51,.8); margin:12px 0; }

    ul{ margin:8px 0 0; padding-left: 18px; color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Pages */
    .page{ display:none; }
    .page.active{ display:block; }

    /* Bottom Nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(11,11,12,.88);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(38,38,51,.75);
      z-index: 20;
    }
    .nav .bar{
      max-width:980px; margin:0 auto;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .tab{
      padding: 10px 8px;
      border-radius: 14px;
      background: rgba(15,15,18,.7);
      border: 1px solid rgba(38,38,51,.8);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(124,92,255,.7);
      background: radial-gradient(160px 60px at 50% 0%, rgba(124,92,255,.25), transparent 70%), rgba(15,15,18,.85);
    }
    .ico{ font-size:16px; line-height:16px; }

    /* Truist-style currency input */
    .currency{
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 88px;
      transform: translateX(-50%);
      background: rgba(17,17,22,.92);
      border: 1px solid rgba(38,38,51,.9);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-size: 12px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 50;
    }
    .toast.show{ display:block; }
  </style>
</head>
<body>

<header>
  <div class="title">
    <div class="brand">
      <h1>Money OS</h1>
      <div class="sub">Simple pages ‚Ä¢ Truist inputs ‚Ä¢ Buttons for real life</div>
    </div>
    <div class="pill" id="miniStatus">Loading‚Ä¶</div>
  </div>
</header>

<div class="wrap">

  <!-- HOME -->
  <section class="page active" id="page-home">
    <div class="grid">
      <div class="card">
        <h2>Snapshot <span class="pill" id="statusPill">‚Äî</span></h2>
        <div class="big" id="allowanceBig">$0.00 <span class="muted">allowance</span></div>
        <div class="muted" id="balancesLine">Bills: $0 ‚Ä¢ Buffer: $0 ‚Ä¢ Trips: $0</div>
        <div class="line"></div>
        <div class="muted small" id="next10Line">Next 10 days obligations: $0</div>
        <div class="muted small" id="billsAfterLine">Bills after obligations: $0</div>
      </div>

      <div class="card">
        <h2>Payday Script</h2>
        <div class="muted">Tap for transfer guidance (doesn‚Äôt move money).</div>
        <div class="line"></div>
        <button onclick="runPaydayScript()">Run Payday Script</button>
      </div>
    </div>
  </section>

  <!-- ACTIONS -->
  <section class="page" id="page-actions">
    <div class="grid">
      <div class="card">
        <h2>Quick Actions</h2>
        <div class="muted">Buttons + Truist-style amount entry.</div>
        <div class="line"></div>
        <div class="row">
          <button onclick="actGotPaid()">üíµ Got Paid</button>
          <button class="secondary" onclick="actWindfall()">üí∞ Refund / Sale</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="secondary" onclick="actMoveMoney()">üîÅ Move Money</button>
          <button class="danger" onclick="actResetAllowance()">üóì Reset Allowance</button>
        </div>
        <div class="line"></div>
        <div class="row">
          <button class="secondary" onclick="actPayDebt()">üî• Pay Debt (Amex)</button>
          <button class="secondary" onclick="actPayBill()">üßæ Pay Bill</button>
        </div>
      </div>

      <div class="card">
        <h2>Safe to Spend?</h2>
        <label>Amount</label>
        <input class="currency" id="safeAmt" inputmode="numeric" placeholder="$0.00">
        <label>Type</label>
        <select id="safeType">
          <option value="allowance">Allowance (normal)</option>
          <option value="bills">Bills (essential only)</option>
          <option value="trips">Trips (travel)</option>
        </select>
        <div class="line"></div>
        <button class="secondary" onclick="checkSafe()">Check</button>
        <div class="line"></div>
        <div class="mono small" id="safeOut"></div>
      </div>
    </div>
  </section>

  <!-- TRIPS -->
  <section class="page" id="page-trips">
    <div class="grid">
      <div class="card">
        <h2>Trip Countdown</h2>
        <label>Trip date</label>
        <input id="tripDate" type="date">
        <div class="row">
          <div>
            <label>Trip target</label>
            <input class="currency" id="tripTarget" inputmode="numeric" placeholder="$0.00">
          </div>
          <div>
            <label>Pay cycle</label>
            <select id="payCycle">
              <option value="biweekly">Biweekly</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>
        <div class="line"></div>
        <button class="secondary" onclick="updateTripPlan()">Update</button>
        <div class="line"></div>
        <div id="tripOut" class="small muted"></div>
      </div>

      <div class="card">
        <h2>Trip Fund Balance</h2>
        <div class="big" id="tripBig">$0.00</div>
        <div class="muted">Fund trips only after Bills + Buffer are safe.</div>
      </div>
    </div>
  </section>

  <!-- DEBT -->
  <section class="page" id="page-debt">
    <div class="grid">
      <div class="card">
        <h2>Debt Inputs</h2>
        <label>Amex balance</label>
        <input class="currency" id="amexBal" inputmode="numeric" placeholder="$0.00">
        <label>Amex APR (%)</label>
        <input id="amexApr" inputmode="decimal" placeholder="28.49">

        <label>Installments total</label>
        <input class="currency" id="instBal" inputmode="numeric" placeholder="$0.00">

        <label>Extra per paycheck</label>
        <input class="currency" id="extraPerPaycheck" inputmode="numeric" placeholder="$0.00">

        <label>Strategy</label>
        <select id="debtStrategy">
          <option value="amex_first">Amex first</option>
          <option value="installments_first">Installments first</option>
          <option value="split">Split 70/30</option>
        </select>
        <div class="line"></div>
        <button class="secondary" onclick="calcDebtPlan()">Calculate</button>
      </div>

      <div class="card">
        <h2>Payoff Estimate</h2>
        <div id="debtOut" class="small muted">Enter balances and calculate.</div>
      </div>
    </div>
  </section>

  <!-- WINS -->
  <section class="page" id="page-wins">
    <div class="grid">
      <div class="card">
        <h2>Impulse Wins</h2>
        <label>What you didn‚Äôt buy</label>
        <input id="winItem" placeholder="Amazon gadget, snacks, gear, etc.">
        <label>Amount avoided</label>
        <input class="currency" id="winAmt" inputmode="numeric" placeholder="$0.00">
        <div class="line"></div>
        <button class="secondary" onclick="logWin()">Log Win</button>
        <div class="line"></div>
        <div id="winsOut" class="small muted"></div>
        <div class="line"></div>
        <button class="ghost" onclick="clearWins()">Clear Wins</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section class="page" id="page-settings">
    <div class="grid">
      <div class="card">
        <h2>Targets</h2>
        <label>Weekly allowance</label>
        <input class="currency" id="weekly" inputmode="numeric" placeholder="$0.00">

        <label>Bills minimum (floor)</label>
        <input class="currency" id="billsMin" inputmode="numeric" placeholder="$0.00">

        <label>Bills ideal</label>
        <input class="currency" id="billsIdeal" inputmode="numeric" placeholder="$0.00">

        <label>Buffer target</label>
        <input class="currency" id="bufferTarget" inputmode="numeric" placeholder="$0.00">

        <label>Buffer floor</label>
        <input class="currency" id="bufferFloor" inputmode="numeric" placeholder="$0.00">

        <div class="line"></div>
        <button onclick="saveSettings()">Save Settings</button>
      </div>

      <div class="card">
        <h2>Balances</h2>
        <div class="muted">Set these once, then use Actions buttons going forward.</div>
        <div class="line"></div>

        <label>Bills</label>
        <input class="currency" id="bills" inputmode="numeric" placeholder="$0.00">

        <label>Allowance</label>
        <input class="currency" id="allow" inputmode="numeric" placeholder="$0.00">

        <label>Buffer</label>
        <input class="currency" id="buffer" inputmode="numeric" placeholder="$0.00">

        <label>Trips</label>
        <input class="currency" id="trips" inputmode="numeric" placeholder="$0.00">

        <div class="line"></div>
        <button class="secondary" onclick="saveBalances()">Save Balances</button>
      </div>
    </div>
  </section>

</div>

<!-- Bottom Nav -->
<nav class="nav">
  <div class="bar">
    <div class="tab active" data-to="home"><div class="ico">üè†</div>Home</div>
    <div class="tab" data-to="actions"><div class="ico">‚ö°Ô∏è</div>Actions</div>
    <div class="tab" data-to="trips"><div class="ico">‚úàÔ∏è</div>Trips</div>
    <div class="tab" data-to="debt"><div class="ico">üî•</div>Debt</div>
    <div class="tab" data-to="wins"><div class="ico">üèÜ</div>Wins</div>
    <div class="tab" data-to="settings"><div class="ico">‚öôÔ∏è</div>Settings</div>
  </div>
</nav>

<div class="toast" id="toast"></div>

<script>
  const LS = "money_os_v4";

  // ---- Utilities ----
  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function load(){
    const d = JSON.parse(localStorage.getItem(LS) || "{}");
    return {
      billsCents: d.billsCents ?? 0,
      allowCents: d.allowCents ?? 0,
      bufferCents: d.bufferCents ?? 0,
      tripsCents: d.tripsCents ?? 0,

      weeklyCents: d.weeklyCents ?? 10000, // $100
      billsMinCents: d.billsMinCents ?? 30000,
      billsIdealCents: d.billsIdealCents ?? 100000,
      bufferTargetCents: d.bufferTargetCents ?? 50000,
      bufferFloorCents: d.bufferFloorCents ?? 30000,

      tripDate: d.tripDate ?? "",
      tripTargetCents: d.tripTargetCents ?? 100000,
      payCycle: d.payCycle ?? "biweekly",

      amexBalCents: d.amexBalCents ?? 0,
      amexApr: d.amexApr ?? 28.49,
      instBalCents: d.instBalCents ?? 0,
      extraCents: d.extraCents ?? 0,
      debtStrategy: d.debtStrategy ?? "amex_first",

      wins: d.wins ?? []
    };
  }

  function save(patch){
    const d = load();
    const merged = {...d, ...patch};
    localStorage.setItem(LS, JSON.stringify(merged));
  }

  function centsToMoney(c){ return (c/100).toFixed(2); }
  function moneyStr(c){ return `$${centsToMoney(c)}`; }
  function digitsToCents(digits){ // "1234" => 1234 cents = $12.34
    const n = parseInt(digits || "0", 10);
    return isNaN(n) ? 0 : n;
  }

  // Truist-style: type digits only; we store cents as digits.
  function attachCurrencyInput(el, initialCents=0, onChange=null){
    el.dataset.cents = String(initialCents);
    el.value = moneyStr(initialCents);

    el.addEventListener("keydown", (e)=>{
      const allowed = ["Backspace","Delete","ArrowLeft","ArrowRight","Tab"];
      if(allowed.includes(e.key)) return;

      if(e.key >= "0" && e.key <= "9"){
        e.preventDefault();
        const cur = el.dataset.cents || "0";
        const next = (cur === "0") ? e.key : (cur + e.key);
        el.dataset.cents = next;
        el.value = moneyStr(digitsToCents(next));
        if(onChange) onChange(digitsToCents(next));
        return;
      }

      // block other keys
      e.preventDefault();
    });

    el.addEventListener("input", (e)=>{ e.preventDefault(); });

    el.addEventListener("paste", (e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = text.replace(/\D/g,"");
      el.dataset.cents = digits || "0";
      el.value = moneyStr(digitsToCents(el.dataset.cents));
      if(onChange) onChange(digitsToCents(el.dataset.cents));
    });

    el.addEventListener("focus", ()=>{ el.setSelectionRange(el.value.length, el.value.length); });

    // Backspace handling
    el.addEventListener("keyup", (e)=>{
      if(e.key === "Backspace" || e.key === "Delete"){
        const cur = el.dataset.cents || "0";
        const next = (cur.length <= 1) ? "0" : cur.slice(0, -1);
        el.dataset.cents = next;
        el.value = moneyStr(digitsToCents(next));
        if(onChange) onChange(digitsToCents(next));
      }
    });
  }

  // ---- Navigation ----
  function showPage(key){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    $("page-"+key).classList.add("active");
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(`.tab[data-to="${key}"]`).forEach(t=>t.classList.add("active"));
  }

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>showPage(t.dataset.to));
  });

  // ---- Core calculations ----
  function obligationsNext10(){ return 0; } // placeholder for now (you can add this later)
  // (We can add an obligations page next; keeping v2 focused.)

  function renderHome(){
    const s = load();
    const bills = s.billsCents, allow = s.allowCents, buffer = s.bufferCents, trips = s.tripsCents;

    $("allowanceBig").innerHTML = `${moneyStr(allow)} <span class="muted">allowance</span>`;
    $("balancesLine").textContent = `Bills: ${moneyStr(bills)} ‚Ä¢ Buffer: ${moneyStr(buffer)} ‚Ä¢ Trips: ${moneyStr(trips)}`;
    $("tripBig").textContent = moneyStr(trips);

    const due10 = obligationsNext10();
    const billsAfter = bills - due10;

    $("next10Line").textContent = `Next 10 days obligations: ${moneyStr(due10)}`;
    $("billsAfterLine").textContent = `Bills after obligations: ${moneyStr(billsAfter)}`;

    // Status pill
    let pill = "ok";
    let label = "Stable";
    if(billsAfter < s.billsMinCents || buffer < s.bufferFloorCents) { pill="bad"; label="Tight"; }
    else if(billsAfter < s.billsIdealCents || buffer < s.bufferTargetCents) { pill="warn"; label="Caution"; }

    $("statusPill").className = `pill ${pill}`;
    $("statusPill").textContent = label;

    $("miniStatus").className = `pill ${pill}`;
    $("miniStatus").textContent = `${label} ‚Ä¢ Bills ${moneyStr(bills)} ‚Ä¢ Buffer ${moneyStr(buffer)}`;
  }

  function runPaydayScript(){
    const s = load();
    const due10 = obligationsNext10();
    const billsNeedFloor = Math.max(0, (s.billsMinCents + due10) - s.billsCents);
    const billsNeedIdeal = Math.max(0, (s.billsIdealCents + due10) - s.billsCents);
    const bufNeedFloor = Math.max(0, s.bufferFloorCents - s.bufferCents);
    const bufNeedTarget = Math.max(0, s.bufferTargetCents - s.bufferCents);
    const allowNeed2w = Math.max(0, (s.weeklyCents*2) - s.allowCents);

    alert(
`PAYDAY SCRIPT

1) Bills (cover next 10 days + floor)
   - Due next 10 days: ${moneyStr(due10)}
   - To Bills floor: ${moneyStr(billsNeedFloor)}
   - To Bills ideal: ${moneyStr(billsNeedIdeal)}

2) Buffer
   - To buffer floor: ${moneyStr(bufNeedFloor)}
   - To buffer target: ${moneyStr(bufNeedTarget)}

3) Allowance
   - Refill 2 weeks: ${moneyStr(allowNeed2w)}

4) Extra ‚Üí Amex ‚Üí Installments ‚Üí Trips
`
    );
  }

  // ---- Actions (Buttons) ----
  function promptCents(label){
    const raw = prompt(label + " (type digits like Truist: 1234 = $12.34)");
    if(raw === null) return null;
    const digits = raw.replace(/\D/g,"");
    const cents = digitsToCents(digits);
    if(cents <= 0) { alert("Enter a valid amount."); return null; }
    return cents;
  }

  function actGotPaid(){
    const cents = promptCents("Paycheck amount received");
    if(cents === null) return;
    const s = load();
    save({ billsCents: s.billsCents + cents });
    toast("Paycheck added to Bills");
    renderAll();
  }

  function actWindfall(){
    const cents = promptCents("Refund / sale amount received");
    if(cents === null) return;
    const choice = prompt("Where should it go? 1=Amex (default) 2=Buffer 3=Trips 4=Bills");
    const s = load();

    if(choice === "2") save({ bufferCents: s.bufferCents + cents });
    else if(choice === "3") save({ tripsCents: s.tripsCents + cents });
    else if(choice === "4") save({ billsCents: s.billsCents + cents });
    else save({ amexBalCents: Math.max(0, s.amexBalCents - cents) });

    toast("Windfall logged");
    renderAll();
  }

  function actMoveMoney(){
    const cents = promptCents("How much are you moving");
    if(cents === null) return;

    const from = (prompt("Move FROM: bills / allow / buffer / trips")||"").trim().toLowerCase();
    const to = (prompt("Move TO: bills / allow / buffer / trips")||"").trim().toLowerCase();

    const s = load();
    const map = { bills: "billsCents", allow:"allowCents", buffer:"bufferCents", trips:"tripsCents" };
    if(!map[from] || !map[to] || from===to) return alert("Invalid from/to.");

    if(s[map[from]] < cents) return alert("Not enough in " + from);

    const patch = {};
    patch[map[from]] = s[map[from]] - cents;
    patch[map[to]] = s[map[to]] + cents;
    save(patch);
    toast(`Moved ${moneyStr(cents)} ${from} ‚Üí ${to}`);
    renderAll();
  }

  function actResetAllowance(){
    const s = load();
    save({ allowCents: s.weeklyCents });
    toast("Allowance reset");
    renderAll();
  }

  function actPayDebt(){
    const cents = promptCents("Debt payment amount (defaults to Amex)");
    if(cents === null) return;
    const s = load();
    save({ amexBalCents: Math.max(0, s.amexBalCents - cents) });
    toast("Amex reduced");
    renderAll();
  }

  function actPayBill(){
    const cents = promptCents("Bill paid amount (reduces Bills balance)");
    if(cents === null) return;
    const s = load();
    save({ billsCents: Math.max(0, s.billsCents - cents) });
    toast("Bill logged");
    renderAll();
  }

  // ---- Safe to Spend ----
  function checkSafe(){
    const amt = digitsToCents($("safeAmt").dataset.cents || "0");
    const type = $("safeType").value;
    const s = load();
    const due10 = obligationsNext10();
    const billsAfter = s.billsCents - due10;

    let ok=true, notes=[];
    if(type==="allowance"){
      if(s.allowCents < amt){ ok=false; notes.push("Allowance insufficient."); }
      if(billsAfter < s.billsMinCents) notes.push("Bills after obligations is below floor (heads-up).");
    } else if(type==="bills"){
      if((billsAfter - amt) < s.billsMinCents){ ok=false; notes.push("Bills would drop below floor after obligations."); }
    } else if(type==="trips"){
      if(s.tripsCents < amt){ ok=false; notes.push("Trips fund insufficient."); }
    }

    $("safeOut").textContent = (ok ? "‚úÖ SAFE" : "‚ùå NOT SAFE") + (notes.length ? ("\n‚Ä¢ "+notes.join("\n‚Ä¢ ")) : "");
  }

  // ---- Trips ----
  function updateTripPlan(){
    const s = load();
    const date = $("tripDate").value;
    const target = digitsToCents($("tripTarget").dataset.cents || "0");
    const cycle = $("payCycle").value;

    save({ tripDate: date, tripTargetCents: target, payCycle: cycle });

    if(!date || target<=0){
      $("tripOut").textContent = "Set a trip date and target.";
      return;
    }

    const now = new Date(); now.setHours(0,0,0,0);
    const td = new Date(date+"T00:00:00");
    const days = Math.max(0, Math.ceil((td-now)/(1000*60*60*24)));
    const remaining = Math.max(0, target - s.tripsCents);

    let periods=1;
    if(cycle==="weekly") periods = Math.max(1, Math.ceil(days/7));
    if(cycle==="biweekly") periods = Math.max(1, Math.ceil(days/14));
    if(cycle==="monthly") periods = Math.max(1, Math.ceil(days/30));

    const perPeriod = Math.ceil(remaining/periods);
    const perWeek = Math.ceil(remaining/Math.max(1,Math.ceil(days/7)));

    $("tripOut").innerHTML =
      `Trips balance: <b>${moneyStr(s.tripsCents)}</b><br>`+
      `Target: <b>${moneyStr(target)}</b> ‚Ä¢ Remaining: <b>${moneyStr(remaining)}</b><br>`+
      `Days until trip: <b>${days}</b><br>`+
      `<div class="line"></div>`+
      `Needed per week: <b>${moneyStr(perWeek)}</b><br>`+
      `Needed per ${cycle}: <b>${moneyStr(perPeriod)}</b>`;
  }

  // ---- Debt ----
  function calcDebtPlan(){
    const s = load();
    const amex = digitsToCents($("amexBal").dataset.cents || "0");
    const apr = parseFloat($("amexApr").value || "0");
    const inst = digitsToCents($("instBal").dataset.cents || "0");
    const extra = digitsToCents($("extraPerPaycheck").dataset.cents || "0");
    const strat = $("debtStrategy").value;

    save({ amexBalCents: amex, amexApr: apr, instBalCents: inst, extraCents: extra, debtStrategy: strat });

    if(extra<=0 || (amex<=0 && inst<=0)){
      $("debtOut").textContent = "Enter balances + an extra per paycheck.";
      return;
    }

    // conservative: 2 paychecks/month
    const extraMonthly = extra*2;
    let months=0;
    let a=amex, i=inst;
    const r=(apr/100)/12;

    while((a>1 || i>1) && months<240){
      months++;
      if(a>1 && r>0) a = Math.round(a*(1+r));

      if(strat==="amex_first"){
        if(a>1) a = Math.max(0, a - extraMonthly);
        else i = Math.max(0, i - extraMonthly);
      } else if(strat==="installments_first"){
        if(i>1) i = Math.max(0, i - extraMonthly);
        else a = Math.max(0, a - extraMonthly);
      } else {
        a = Math.max(0, a - Math.round(extraMonthly*0.7));
        i = Math.max(0, i - Math.round(extraMonthly*0.3));
      }
    }

    $("debtOut").innerHTML =
      `Extra per paycheck: <b>${moneyStr(extra)}</b> (‚âà ${moneyStr(extraMonthly)}/mo)<br>`+
      `Strategy: <b>${strat.replace("_"," ")}</b><br>`+
      `<div class="line"></div>`+
      `Estimated time (extra-only): <b>${months} months</b><br>`+
      `<span class="muted">Minimum payments would shorten this.</span>`;
  }

  // ---- Wins ----
  function logWin(){
    const item = $("winItem").value.trim();
    const cents = digitsToCents($("winAmt").dataset.cents || "0");
    if(!item || cents<=0) return alert("Add an item and amount.");
    const s = load();
    const wins = s.wins.slice();
    wins.unshift({ item, cents, ts: Date.now() });
    save({ wins });
    $("winItem").value="";
    $("winAmt").dataset.cents="0";
    $("winAmt").value="$0.00";
    renderWins();
    toast("Win logged");
  }

  function clearWins(){
    if(!confirm("Clear all wins?")) return;
    save({ wins: [] });
    renderWins();
  }

  function renderWins(){
    const s = load();
    const wins = s.wins || [];
    if(!wins.length){ $("winsOut").textContent="No wins yet."; return; }

    const now = Date.now();
    const weekAgo = now - 7*24*3600*1000;
    let week=0, total=0;
    for(const w of wins){
      total += w.cents;
      if(w.ts >= weekAgo) week += w.cents;
    }

    let html = `<div class="big">${moneyStr(week)} <span class="muted">saved (7d)</span></div>`;
    html += `<div class="muted">All-time: ${moneyStr(total)}</div>`;
    html += `<ul>`;
    for(const w of wins.slice(0,10)){
      html += `<li><b>${moneyStr(w.cents)}</b> ‚Äî ${escapeHtml(w.item)}</li>`;
    }
    html += `</ul>`;
    $("winsOut").innerHTML = html;
  }

  // ---- Settings save ----
  function saveSettings(){
    const weekly = digitsToCents($("weekly").dataset.cents || "0");
    const billsMin = digitsToCents($("billsMin").dataset.cents || "0");
    const billsIdeal = digitsToCents($("billsIdeal").dataset.cents || "0");
    const bufTarget = digitsToCents($("bufferTarget").dataset.cents || "0");
    const bufFloor = digitsToCents($("bufferFloor").dataset.cents || "0");

    save({
      weeklyCents: weekly,
      billsMinCents: billsMin,
      billsIdealCents: billsIdeal,
      bufferTargetCents: bufTarget,
      bufferFloorCents: bufFloor
    });
    toast("Settings saved");
    renderAll();
  }

  function saveBalances(){
    const bills = digitsToCents($("bills").dataset.cents || "0");
    const allow = digitsToCents($("allow").dataset.cents || "0");
    const buffer = digitsToCents($("buffer").dataset.cents || "0");
    const trips = digitsToCents($("trips").dataset.cents || "0");

    save({ billsCents: bills, allowCents: allow, bufferCents: buffer, tripsCents: trips });
    toast("Balances saved");
    renderAll();
  }

  function renderAll(){
    const s = load();

    // attach currency inputs once (idempotent)
    const currencyIds = [
      "safeAmt","tripTarget","amexBal","instBal","extraPerPaycheck","winAmt",
      "weekly","billsMin","billsIdeal","bufferTarget","bufferFloor",
      "bills","allow","buffer","trips"
    ];
    for(const id of currencyIds){
      const el = $(id);
      if(!el) continue;
      if(el.dataset.bound === "1") continue;
      el.dataset.bound = "1";

      // set initial cents based on stored state
      let initial = 0;
      const map = {
        safeAmt: 0,
        tripTarget: s.tripTargetCents,
        amexBal: s.amexBalCents,
        instBal: s.instBalCents,
        extraPerPaycheck: s.extraCents,
        winAmt: 0,
        weekly: s.weeklyCents,
        billsMin: s.billsMinCents,
        billsIdeal: s.billsIdealCents,
        bufferTarget: s.bufferTargetCents,
        bufferFloor: s.bufferFloorCents,
        bills: s.billsCents,
        allow: s.allowCents,
        buffer: s.bufferCents,
        trips: s.tripsCents
      };
      initial = map[id] ?? 0;
      attachCurrencyInput(el, initial);
    }

    // non-currency inputs
    if(!$("tripDate").dataset.bound){
      $("tripDate").dataset.bound="1";
      $("tripDate").value = s.tripDate || "";
      $("payCycle").value = s.payCycle || "biweekly";
      $("amexApr").value = s.amexApr ?? 28.49;
      $("debtStrategy").value = s.debtStrategy ?? "amex_first";
    }

    renderHome();
    renderWins();

    // update outputs when on those pages
    updateTripPlan();
    calcDebtPlan();
  }

  // init
  (function init(){
    const d = JSON.parse(localStorage.getItem(LS) || "{}");
    if(Object.keys(d).length === 0){
      save(load()); // seeds defaults
    }
    renderAll();
  })();
</script>
</body>
</html>
